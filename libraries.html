<!DOCTYPE html>
<html lang="en">

<head>
    <title>Informer 文献馆</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
</head>

<body>
    <div id="libraries">
        <v-app>

            <v-navigation-drawer v-model="drawer" app>
                <v-list>
                    <v-subheader>Informer</v-subheader>
                    <v-list-item-group>
                        <v-list-item href="/">
                            首页
                        </v-list-item>
                        <v-list-item href="/libraries.html" disabled>
                            文献馆
                        </v-list-item>
                        <v-list-item href="/login.html">
                            登录
                        </v-list-item>
                        <v-list-item href="/logout.html">
                            注销
                        </v-list-item>
                        <v-list-item href="/change-password.html">
                            修改密码
                        </v-list-item>
                        <v-list-item href="/change-password.html">
                            修改主密码
                        </v-list-item>
                    </v-list-item-group>
                </v-list>
            </v-navigation-drawer>

            <v-app-bar app>
                <v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>

                <v-toolbar-title>
                    {{ title }}
                </v-toolbar-title>
            </v-app-bar>

            <v-main>
                <v-container>
                    <v-text-field type="password" v-model="key" label="Key"
                        placeholder="Type your master password here"></v-text-field>
                    <v-btn @click="decryptSecure">
                        <div v-if="key">解密</div>
                        <div v-else>刷新</div>
                    </v-btn>

                    <v-dialog v-model="processingDialog" hide-overlay persistent>
                        <v-card color="primary" dark>
                            <v-card-text>
                                请稍候
                                <v-progress-linear indeterminate></v-progress-linear>
                            </v-card-text>
                        </v-card>
                    </v-dialog>

                    <v-btn @click="addForm = !addForm">添加密码</v-btn>
                    <v-card-text v-if="addForm">
                        <v-container>
                            <v-row>
                                <v-col>
                                    <v-text-field v-model="tmpSecure.id" label="ID"></v-text-field>
                                </v-col>
                                <v-col>
                                    <v-text-field v-model="tmpSecure.platform" label="Platform">
                                    </v-text-field>
                                </v-col>
                                <v-col>
                                    <v-text-field v-model="tmpSecure.friendlyName" label="Friendly name">
                                    </v-text-field>
                                </v-col>
                            </v-row>
                            <v-row>
                                <v-col>
                                    <v-text-field v-model="tmpSecure.username" label="Username">
                                    </v-text-field>
                                </v-col>
                                <v-col>
                                    <v-text-field v-model="tmpSecure.password" label="Password" type="password">
                                    </v-text-field>
                                </v-col>
                                <v-col>
                                    <v-text-field v-model="editedItem.key" label="Key" type="password"></v-text-field>
                                </v-col>
                            </v-row>
                            <v-row>
                                <v-col>
                                    <v-btn @click="addSecure">提交</v-btn>
                                </v-col>
                            </v-row>
                        </v-container>
                    </v-card-text>
                    <v-data-table :headers="tableHeaders" :items="secures" item-key="primaryKey"></v-data-table>
                </v-container>
            </v-main>

        </v-app>
    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<script>
    axios.interceptors.response.use(
        response => {
            return response
        },
        error => {
            if (error.response.status === 403) {
                alert('未登录，将跳转到登录页面')
                window.location.href = "/login.html"
            }
            return error
        }
    )

    const libraries = new Vue(
        {
            el: '#libraries',
            vuetify: new Vuetify(),
            data: {
                drawer: null,
                title: '文献馆',
                key: '',
                addForm: false,
                processingDialog: false,

                editedItem: {
                    secure: [],
                    key: ''
                },
                tmpSecure: {
                    id: '',
                    platform: '',
                    friendlyName: '',
                    username: '',
                    password: '',
                },
                tableHeaders: [
                    {
                        text: 'ID',
                        align: 'start',
                        sortable: false,
                        value: 'id'
                    },
                    {
                        text: 'Platform',
                        sortable: false,
                        value: 'platform'
                    },
                    {
                        text: 'Friendly Name',
                        sortable: false,
                        value: 'friendly-name'
                    },
                    {
                        text: 'Username',
                        sortable: false,
                        value: 'username'
                    },
                    {
                        text: 'Password',
                        sortable: false,
                        value: 'password'
                    },
                    {
                        text: 'OTP',
                        sortable: false,
                        value: 'otp'
                    },
                    {
                        text: 'OTP Type',
                        sortable: false,
                        value: 'otp-type'
                    }
                ],
                secures: []
            },
            computed: {
                primaryKey() {
                    return this.secures.map((secure, index) => ({
                        id: index,
                        ...secure
                    }))
                }
            },
            methods: {
                decryptSecure: function () {
                    const self = this
                    url = '/api/libraries?key=' + this.key
                    axios.get(url)
                        .then(function (response) {
                            self.secures = response.data
                        });
                },
                addSecure: function () {
                    let self = this
                    this.processingDialog = true

                    //Clear array
                    this.editedItem.secure.length = 0
                    this.editedItem.secure.push(this.tmpSecure)
                    this.cleartmpSecure()
                    const json_add_info = JSON.stringify(this.$data.editedItem)
                    axios.post('/api/libraries/add', json_add_info).then(
                        function (response) {
                            self.processingDialog = false
                            if (response.status === 200) {
                                alert('添加成功')
                            } else {
                                alert('添加失败')
                            }
                        }
                    )
                },
                cleartmpSecure: function () {
                    this.tmpSecure.id = ''
                    this.tmpSecure.platform = ''
                    this.tmpSecure.friendlyName = ''
                    this.tmpSecure.username = ''
                    this.tmpSecure.password = ''
                }
            }
        }
    )

    //Show secures by default
    libraries.decryptSecure()

    libraries.$vuetify.theme.dark = window.matchMedia('(prefers-color-scheme: dark)').matches
</script>
